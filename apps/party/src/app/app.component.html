<destiny-webring></destiny-webring>
<div class="main-content">
  <destiny-bungie-status class="bungieStatus"></destiny-bungie-status>

  <div class="title-block section">
    <div class="title">
      <span class="srl srl-one">SRL</span>¹ is Dead<br />
      Long Live <span class="srl srl-two">SRL</span>²
    </div>
    <div class="footnotes">
      1: Sparrow Racing League <br />
      2: Synchronized Random Loadouts
    </div>
  </div>

  <div style="margin-bottom: 1em">
    <button
      *ngIf="(bungieAuth.hasValidAccessToken$ | async) === false"
      mat-raised-button
      color="primary"
      class="button"
      (click)="login()"
    >
      Login with Bungie
      <mat-icon aria-label="Login with Bungie">login</mat-icon>
    </button>
    <button
      *ngIf="bungieAuth.hasValidAccessToken$ | async"
      mat-raised-button
      class="button"
      (click)="logout()"
    >
      Logout <mat-icon aria-label="Logout">logout</mat-icon>
    </button>
  </div>

  <form
    (ngSubmit)="joinRoom()"
    *ngIf="
      (bungieAuth.hasValidAccessToken$ | async) && manifestState === 'ready'
    "
  >
    <mat-form-field class="example-full-width">
      <mat-label>Fireteam Code</mat-label>
      <input
        matInput
        placeholder="ABCD"
        [(ngModel)]="roomCode"
        [ngModelOptions]="{ standalone: true }"
        [readonly]="joinedRoom"
        uppercase
        maxlength="4"
      />
    </mat-form-field>
    <button
      color="primary"
      type="submit"
      mat-raised-button
      *ngIf="!joinedRoom"
      [disabled]="
        (playerService.localPlayer$ | async) === null || roomCode.length !== 4
      "
    >
      Join Fireteam
      <mat-icon aria-label="Leave Fireteam">group</mat-icon>
    </button>
    <button
      color="accent"
      (click)="newRoom()"
      mat-raised-button
      *ngIf="!joinedRoom"
      [disabled]="(playerService.localPlayer$ | async) === null"
    >
      Create Fireteam
      <mat-icon aria-label="Create Fireteam">group_add</mat-icon>
    </button>
    <button
      color="warn"
      (click)="leaveRoom()"
      mat-raised-button
      *ngIf="joinedRoom"
    >
      Leave Fireteam
      <mat-icon aria-label="Leave Fireteam">group_off</mat-icon>
    </button>
    <button
      color="accent"
      (click)="copyCode()"
      mat-raised-button
      *ngIf="joinedRoom"
    >
      Copy Fireteam Code
      <mat-icon aria-label="Copy Fireteam Code">content_copy</mat-icon>
    </button>
  </form>

  <mat-spinner *ngIf="manifestState === 'loading'"></mat-spinner>

  <div class="section" *ngIf="manifestState === 'erred'">
    Error loading Destiny Manifest
  </div>

  <mat-card class="section" *ngIf="manifestState === 'ready' && joinedRoom">
    <mat-card-header>
      <mat-card-title>SRL²</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="items">
        <img
          *ngFor="let item of currentLoadout"
          [src]="'https://bungie.net' + item.displayProperties.icon"
          [title]="item.displayProperties.name"
          class="item-icon"
        />
      </div>
    </mat-card-content>

    <mat-card-actions>
      <button
        [disabled]="playerService.combinedSetsLoading | async"
        color="primary"
        (click)="randomize()"
        mat-raised-button
      >
        New Loadout
        <mat-icon aria-label="Randomize Loadout">shuffle</mat-icon>
      </button>
      <button
        [disabled]="(playerService.combinedSetsLoading | async) || !searchText"
        color="accent"
        (click)="copySearch()"
        mat-raised-button
      >
        Copy DIM Search
        <mat-icon aria-label="Copy DIM Search">content_copy</mat-icon>
      </button>
      <button [disabled]="true" color="accent" mat-raised-button>
        Equip Loadout
        <mat-icon aria-label="Coming Soon...">flip_to_front</mat-icon>
      </button>
    </mat-card-actions>

    <mat-card-footer *ngIf="requiresPull">
      Some items may be in Collections
    </mat-card-footer>
  </mat-card>

  <div class="section" *ngIf="manifestState === 'ready' && joinedRoom">
    <h2>Guardians</h2>
    <div class="player-cards">
      <destiny-player
        *ngFor="let player of playerService.players$ | async; index as i"
        [player]="player"
        [index]="i"
        [exotics]="exotics"
        [collectionExotics]="collectionExotics"
        [collectionNonExotics]="collectionNonExotics"
      ></destiny-player>

      <mat-card *ngIf="playerService.combinedSetsLoading | async">
        <mat-spinner></mat-spinner>
      </mat-card>
      <mat-card *ngIf="(playerService.combinedSetsLoading | async) === false">
        <mat-card-header>
          <mat-card-title>Commonality</mat-card-title>
        </mat-card-header>
        <mat-card-content> </mat-card-content>
        <mat-card-actions>
          <mat-chip-set>
            <mat-chip class="non-exotics">
              {{ nonExoticCount }} Non-Exotics
            </mat-chip>
            <mat-chip *ngIf="exotics !== 'exclude'" class="exotics">
              {{ exoticCount }} Exotics
            </mat-chip>
          </mat-chip-set>
        </mat-card-actions>
      </mat-card>
    </div>
  </div>

  <div class="section" *ngIf="manifestState === 'ready' && joinedRoom">
    <h2>Options</h2>

    <div class="option-cards">
      <mat-card>
        <mat-card-header>
          <mat-card-title>Exotics</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <mat-radio-group
            aria-label="Exotics"
            [(ngModel)]="exotics"
            (change)="updateCounts()"
          >
            <mat-radio-button value="exclude">Never</mat-radio-button>
            <mat-radio-button value="include" [checked]="true"
              >Sometimes</mat-radio-button
            >
            <mat-radio-button value="required">Always</mat-radio-button>
          </mat-radio-group>
        </mat-card-content>
      </mat-card>

      <mat-card>
        <mat-card-header
          ><mat-card-title>Collections</mat-card-title></mat-card-header
        >
        <mat-card-content>
          <mat-checkbox
            [(ngModel)]="collectionNonExotics"
            (change)="updateCounts()"
            >Non-Exotics</mat-checkbox
          ><br />
          <mat-checkbox
            *ngIf="exotics !== 'exclude'"
            [(ngModel)]="collectionExotics"
            (change)="updateCounts()"
            >Exotics</mat-checkbox
          >
        </mat-card-content>
      </mat-card>

      <mat-card>
        <mat-card-header
          ><mat-card-title>Require</mat-card-title></mat-card-header
        >
        <mat-card-content>
          <mat-checkbox [(ngModel)]="requirePrimary">Primary</mat-checkbox
          ><br />
          <mat-checkbox [(ngModel)]="requireSpecial">Special</mat-checkbox>
        </mat-card-content>
      </mat-card>

      <mat-card>
        <mat-card-header>
          <mat-card-title>Discord Integration</mat-card-title>
          <mat-card-subtitle
            >Automatically send search text to a Discord
            channel</mat-card-subtitle
          >
        </mat-card-header>
        <mat-card-content>
          <mat-form-field color="accent">
            <mat-label>Discord Webhook URL</mat-label>
            <input
              title="Discord Webhook URL"
              matInput
              [(ngModel)]="discordWebhookUrl"
              type="password"
            />
          </mat-form-field>
          <mat-form-field color="accent">
            <mat-label>Thread ID (optional)</mat-label>
            <input
              title="Thread ID"
              matInput
              [(ngModel)]="discordThreadId"
              type="password"
            />
          </mat-form-field>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>
